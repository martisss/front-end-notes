# 计网

## 概述

### ISP(网络服务提供商)

### 主机间通讯方式

c/s
p2p

### 电路交换与分组交换

前者用于电话通信系统，线路利用率低
后者每个分组都有首部和尾部，包含了源地址和目的地址等控制信息，在同一个传输线路上同时传输多个分组互相不会影响

### 时延

总时延 = 排队时延 + 处理时延 + 传输时延 + 传播时延

### 计算机网络体系结构

几种常用的[广域网](https://baike.baidu.com/item/广域网)：[公用电话交换网](https://baike.baidu.com/item/公用电话交换网)（ P S T N）、分组交换网（X . 2 5）、[数字数据网](https://baike.baidu.com/item/数字数据网)（ D D N）、[帧中继](https://baike.baidu.com/item/帧中继)（ F R）、[交换式多兆位数据服务](https://baike.baidu.com/item/交换式多兆位数据服务)（ S M D S）和[异步传输模式](https://baike.baidu.com/item/异步传输模式)（AT M）。

> **局域网技术**
>
> 令牌环网
>
> 光纤分布式数据接口FDDI（Fiber Distributed Data Interface）
>
> **广域网技术**
>
> 综合业务数字网（ISDN）就是一种采用电路交换技术的广域网技术。
>
> ATM，帧中继，SMDS以及X.25等都是采用包交换技术的广域网技术。

- 五层协议
- OSI
- TCP/IP

![image.png](https://s2.loli.net/2022/02/09/eIgm7dLpuWsOj1H.png)



  **物理层：**通过媒介传输比特,确定机械及电气规范（比特Bit）

  **数据链路层**：将比特组装成帧和点到点的传递（帧Frame）

  **网络层**：负责数据包从源到宿的传递和网际互连（包PackeT）

  **传输层**：提供端到端的可靠报文传递和错误恢复（段Segment）

  **会话层**：建立、管理和终止会话（会话协议数据单元SPDU）

  **表示层**：对数据进行翻译、加密和压缩（表示协议数据单元PPDU）

  **应用层**：允许访问OSI环境的手段（应用协议数据单元APDU）

> **网桥（Bridge)**也称为桥接器，是连接两个局域网的存储转发设备，用它可以使完全具有相同或相似体系结构网络系统的连接，这样不但能扩展网络的距离或范围，而且可提高网络的性能、可靠性和安全性。网桥工作在OSI参考模型的数据链路层（第二层），将两个LAN连起来，根据MAC地址来转发帧。
>
> > 网桥的基本特征：
> >
> > 1. 网桥在数据链路层上实现局域网互连
> > 2. **网桥能够互连两个采用不同数据链路层协议、不同传输介质与不同传输速率的网络。所以C正确**
> > 3. 网桥以接收、存储、地址过滤与转发的方式实现互连的网络之间的通信
> > 4. 网桥需要互连的网络在数据链路层以上采用相同的协议**（**OSI七层模型从下到上：物理层 数据链路层 **网络层 传输层 会话层 表示层 应用层****）**
> > 5. 网桥可以分隔两个网络之间的通信量，有利于改善互连网络的性能与安全性
>
> **交换机**是主导网络系统的集线设备，大部分交换机是在OSI参考模型的数据链路层（第二层）操作。
>
> 值得注意的是，网桥与交换机的区别在于市场，而不在与技术。交换机对网络进行分段的方式与网桥相同，交换机就是一个多端口的网桥。确切地说，高端口密度的网桥就称为局域网交换机
>
> **网关**工作在传输层及以上层次
>
> > **交换机攻击主要有以下5种类型：**
> >
> > **1.**VLAN跳跃攻击
> >
> > **2.**生成树攻击
> >
> > **3.**MAC表洪水攻击
> >
> > **4.**ARP攻击
> >
> > **5.**VTP攻击
> >
> > DCHP攻击：利用了交换机端口安全功能，MAC动态地址锁和端口静态绑定MAC，来限定交换机某个端口上可以访问网络的MAC地址，从而进行控制。
> >
> > 而目录遍历攻击是HTTP所存在的一个安全漏洞，它使得攻击者能够访问受限的目录，并在Web服务器的根目录以外执行命令。不属于交换机攻击

### 数据在各层之间传递

在向下的过程中，需要添加下层协议所需要的首部或者尾部，而在向上的过程中不断拆开首部和尾部。

决定局域网·特性的主要技术要素包括**网络拓扑结构、传输介质与介质访问控制方法**。其中最主要的是**介质访问控制方法。**

![image.png](https://s2.loli.net/2022/02/09/BZcOWPozXigf1kw.png)

## 物理层

物理层的特性有机械特性、电气特性、规程特性和功能特性

### 通信方式

单工，半双工，全双工

在计算机网络中，带宽表示网络的通信线路所能传送数据的能力，是数字信道所能传送的“最高数据率”的同意语，单位是“比特每秒”(b/s)

  吞吐量：表示在单位时间内通过某个网络(或信道、接口)的数据量。吞吐量受网络的带宽或网络的额定速率的限制。

### 带通调制

把离散的数字信号转换为连续的模拟信号

### mac地址

MAC地址又称硬件地址或物理地址，它是由网卡决定的，也就是固定且唯一的，前24位是由IEEE机构分配给厂家，而后24位可以由厂家自己分配。

> 最小帧长=总线传播时延* 数据传输速率* 2	

## 链路层

### 基本问题

- 封装成帧

  将网络层传下来的分组添加首部和尾部，用于标记帧的开始和结束。

- 透明传输

  简单的说就是什么都可以传，帧使用首部（SOH）和尾部(EOT)定界， 如果数据部分含有首部尾部内容，则需要使用转义字符(ESC)

- 差错检测

  广泛使用了循环冗余检验（CRC）来检查比特差错

### **主要功能**

（前五个为重点）：用于两个设备(同一种数据链路节点)之间进行信息传递。

**1.成帧(帧同步)：了避免接收到的位数量以及数值发生异常。**

**2. 差错控制：为了确保数据通信的准确，降低错误发生的几率。**

**3. 流量控制：了确保数据通信的有序进行，避免通信过程中不会出现接收方来不及接收而造成数据丢失。**

**4. 链路控制：包括数据链路的建立、链路的维持和释放，**

**5. MAC寻址：寻找地址是计算机网卡的\*MAC\*地址，与寻址ip地址不同**

**6. 区分数据和控制信息：在许多情况下，数据和控制信息处于同一帧中**

**7. 透明传输：可以让无论是哪种比特组合的数据，都可以在数据链路上进行有效传输。**

### 信道分类

- 广播信道

	- 信道复用

	  频分复用
	  时分复用
	  统计时分复用
	  码分复用
	  波分复用

	- CSMA/CD协议

	  载波监听多点接入/碰撞检测
	  多点接入说明是总线型网络

- 点对点信道

	- PPP协议

	  互联网用户通常需要连接到某个 ISP 之后才能接入到互联网，PPP 协议是用户计算机和 ISP 进行通信时所使用的数据链路层协议。

### MAC地址

唯一标识网络适配器

### 局域网

局域网是一种典型的广播信道，主要特点是网络为一个单位所拥有，且地理范围和站点数目均有限。
主要有以太网、令牌环网、FDDI 和 ATM 等局域网技术，目前以太网占领着有线局域网市场。


星型 环形 直线型

### 以太网

星型拓扑结构局域网

早期使用集线器，可能会发生碰撞
目前使用交换机（即插即用）代替，不会发生碰撞，能根据 MAC 地址进行存储转发。

## 网络层

### IP数据报格式

### IP编址方式

A类地址：1.0.0.0~126.255.255.254

B类地址：128.0.0.0~191.255.255.255

C类地址：192.0.0.0~223.255.255.255

> A类地址中，10.0.0.0到10.255.255.255是私有地址
>
> 在B类地址中，172.16.0.0到172.31.255.255是私有地址
>
> 在C类地址中，192.168.0.0到192.168.255.255是私有地址
>
> 127.0.0.1 本机回送地址  做测试用

IP子网划分

- B类地址有16位是主机号的位数
- 公式：![图片说明](https://www.nowcoder.com/equation?tex=%E5%AD%90%E7%BD%91%E5%86%85%E4%B8%BB%E6%9C%BA%E6%95%B0%3D2%5E%7Bx%7D-2%EF%BC%88x%E6%98%AF%E4%B8%BB%E6%9C%BA%E5%8F%B7%E7%9A%84%E4%BD%8D%E6%95%B0%EF%BC%89)
- 减去的2个一个是主机号全为0的**网络地址**，另一个主机号全1是**广播地址**
- 记住：网络地址+1是第一个主机地址，广播地址-1是最后的主机地址

### IPV6

```
IPv6地址类型可分为单播地址，组播地址和任播地址，不是广播地址。
单播地址：可作为原地址和目的地址。单点发送。
组播地址和任播地址，目的地址可有多个。任播地址：标识网络中的一组主机，只可作为IPv6分组的目的地址，但当向一个任播地址发送IP分组时，只有该任播地址标识的任播组的某个成员收到该IP分组。组播地址是组播地址标识的多播组每个成员都会收到一个该IP分组的一个副本。
```

### 虚拟专用网

### NAT

### 路由器

- 功能

  - 分组转发

    从数据报的首部提取目的主机的 IP 地址 D，得到目的网络地址 N。
    若 N 就是与此路由器直接相连的某个网络地址，则进行直接交付；
    若路由表中有目的地址为 D 的特定主机路由，则把数据报传送给表中所指明的下一跳路由器；
    若路由表中有到达网络 N 的路由，则把数据报传送给路由表中所指明的下一跳路由器；
    若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；
    报告转发分组出错。
    > IP地址与网络地址的区别就是IP地址可分配给主机，网络地址不可分配给主机。IP地址一般是指主机的地址。网络地址是网络地址（网络号）路由器或三层交换机对数据包进行路由选择的。子网掩码和IP地址相与得到了了网络地址。
    子网掩码和IP地址相与得到了了网络地址。

  - 路由选择

    路由选择协议都是自适应的，能随着网络通信量和拓扑结构的变化而自适应地进行调整。
    可以把路由选择协议划分为两大类：
    自治系统内部的路由选择：RIP 和 OSPF
    自治系统间的路由选择：BGP
    
    
    1. 内部网关协议 RIP
    RIP 是一种基于距离向量的路由选择协议。距离是指跳数，直接相连的路由器跳数为 1。跳数最多为 15，超过 15 表示不可达。
    RIP 按固定的时间间隔仅和相邻路由器交换自己的路由表，经过若干次交换之后，所有路由器最终会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器地址。
    距离向量算法：
    对地址为 X 的相邻路由器发来的 RIP 报文，先修改报文中的所有项目，把下一跳字段中的地址改为 X，并把所有的距离字段加 1；
    对修改后的 RIP 报文中的每一个项目，进行以下步骤：
    若原来的路由表中没有目的网络 N，则把该项目添加到路由表中；
    否则：若下一跳路由器地址是 X，则把收到的项目替换原来路由表中的项目；否则：若收到的项目中的距离 d 小于路由表中的距离，则进行更新（例如原始路由表项为 Net2, 5, P，新表项为 Net2, 4, X，则更新）；否则什么也不做。
    若 3 分钟还没有收到相邻路由器的更新路由表，则把该相邻路由器标为不可达，即把距离置为 16。
    RIP 协议实现简单，开销小。但是 RIP 能使用的最大距离为 15，限制了网络的规模。并且当网络出现故障时，要经过比较长的时间才能将此消息传送到所有路由器。
    
    2. 内部网关协议 OSPF
    开放最短路径优先 OSPF，是为了克服 RIP 的缺点而开发出来的。
    开放表示 OSPF 不受某一家厂商控制，而是公开发表的；最短路径优先表示使用了 Dijkstra 提出的最短路径算法 SPF。
    OSPF 具有以下特点：
    向本自治系统中的所有路由器发送信息，这种方法是洪泛法。
    发送的信息就是与相邻路由器的链路状态，链路状态包括与哪些路由器相连以及链路的度量，度量用费用、距离、时延、带宽等来表示。
    只有当链路状态发生变化时，路由器才会发送信息。
    所有路由器都具有全网的拓扑结构图，并且是一致的。相比于 RIP，OSPF 的更新过程收敛的很快。
    
    3. 外部网关协议 BGP
        BGP（Border Gateway Protocol，边界网关协议）
        AS 之间的路由选择很困难，主要是由于：互联网规模很大；
        各个 AS 内部使用不同的路由选择协议，无法准确定义路径的度量；
    
      BGP 系统的主要功能是和其他的BGP系统交换网络可达信息
    
      AS 之间的路由选择必须考虑有关的策略，比如有些 AS 不愿意让其它 AS 经过。
      BGP 只能寻找一条比较好的路由，而不是最佳路由。
      每个 AS 都必须配置 BGP 发言人，通过在两个相邻 BGP 发言人之间建立 TCP 连接来交换路由信息。

- 结构

  交换结构、一组输入端口和一组输出端口。
  
- 实现交换结构的方法有三种常用的方法：

  1、通过存储器

  2、通过总线

  3、通过互联网络

## 应用层

### 域名系统

DNS 是一个分布式数据库，提供了主机名和 IP 地址之间相互转换的服务。
可以使用TCP或者udp传输，端口号为53；
大部分情况下使用udp传输，下面两种情况使用tcp
如果返回的响应超过的 512 字节（UDP 最大只支持 512 字节的数据）。
区域传送（区域传送是主域名服务器向辅助域名服务器传送变化的那部分数据）

> DNS 服务的常见资源记录类型：A记录（主机地址）、CNAME记录（别名）、MX记录（邮件主机）、NS记录（名称服务器）、SOA记录（起始授权机构）、PTR记录（IP反向解析）、SRV记录（MS DNS服务器的活动目录）

### 文件传送协议

FTP 使用 TCP 进行连接，它需要两个连接来传送一个文件：
控制连接：服务器打开端口号 21 等待客户端的连接，客户端主动建立连接后
数据连接：用来传送一个文件数据。
根据数据连接是否是服务器端主动建立，FTP 有主动和被动两种模式：
主动模式：服务器端主动建立数据连接，其中服务器端的端口号为 20，客户端的端口号随机，但是必须大于 1024，因为 0~1023 是熟知端口号。
被动模式：客户端主动建立数据连接，其中客户端的端口号由客户端自己指定，服务器端的端口号随机。、

主动模式要求客户端开放端口号给服务器端，需要去配置客户端的防火墙。被动模式只需要服务器端开放端口号即可，无需客户端配置防火墙。但是被动模式会导致服务器端的安全性减弱，因为开放了过多的端口号。

### 动态主机配置协议

discover -> offer -> request -> ack
使用udp传输
DHCP (Dynamic Host Configuration Protocol) 提供了即插即用的连网方式，用户不再需要手动配置 IP 地址等信息。
DHCP 配置的内容不仅是 IP 地址，还包括子网掩码、网关 IP 地址。
DHCP 工作过程如下：
客户端发送 Discover 报文，该报文的目的地址为 255.255.255.255:67，源地址为 0.0.0.0:68，被放入 UDP 中，该报文被广播到同一个子网的所有主机上。如果客户端和 DHCP 服务器不在同一个子网，就需要使用中继代理。
DHCP 服务器收到 Discover 报文之后，发送 Offer 报文给客户端，该报文包含了客户端所需要的信息。因为客户端可能收到多个 DHCP 服务器提供的信息，因此客户端需要进行选择。
如果客户端选择了某个 DHCP 服务器提供的信息，那么就发送 Request 报文给该 DHCP 服务器。
DHCP 服务器发送 Ack 报文，表示客户端此时可以使用提供给它的信息。

### 电子邮件协议

发送： SMTP
读取： POP3 ， IMAP

- SMTP
- POP3
- IMAP

### Web 页面请求过程

1. DHCP 配置主机信息
假设主机最开始没有 IP 地址以及其它信息，那么就需要先使用 DHCP 来获取。

主机生成一个 DHCP 请求报文，并将这个报文放入具有目的端口 67 和源端口 68 的 UDP 报文段中。
该报文段则被放入在一个具有广播 IP 目的地址(255.255.255.255) 和源 IP 地址（0.0.0.0）的 IP 数据报中。
该数据报则被放置在 MAC 帧中，该帧具有目的地址 FF:<zero-width space>FF:<zero-width space>FF:<zero-width space>FF:<zero-width space>FF:FF，将广播到与交换机连接的所有设备。
连接在交换机的 DHCP 服务器收到广播帧之后，不断地向上分解得到 IP 数据报、UDP 报文段、DHCP 请求报文，之后生成 DHCP ACK 报文，该报文包含以下信息：IP 地址、DNS 服务器的 IP 地址、默认网关路由器的 IP 地址和子网掩码。该报文被放入 UDP 报文段中，UDP 报文段有被放入 IP 数据报中，最后放入 MAC 帧中。
该帧的目的地址是请求主机的 MAC 地址，因为交换机具有自学习能力，之前主机发送了广播帧之后就记录了 MAC 地址到其转发接口的交换表项，因此现在交换机就可以直接知道应该向哪个接口发送该帧。
主机收到该帧后，不断分解得到 DHCP 报文。之后就配置它的 IP 地址、子网掩码和 DNS 服务器的 IP 地址，并在其 IP 转发表中安装默认网关。

2. ARP 解析 MAC 地址
主机通过浏览器生成一个 TCP 套接字，套接字向 HTTP 服务器发送 HTTP 请求。为了生成该套接字，主机需要知道网站的域名对应的 IP 地址。

主机生成一个 DNS 查询报文，该报文具有 53 号端口，因为 DNS 服务器的端口号是 53。
该 DNS 查询报文被放入目的地址为 DNS 服务器 IP 地址的 IP 数据报中。
该 IP 数据报被放入一个以太网帧中，该帧将发送到网关路由器。
DHCP 过程只知道网关路由器的 IP 地址，为了获取网关路由器的 MAC 地址，需要使用 ARP 协议。
主机生成一个包含目的地址为网关路由器 IP 地址的 ARP 查询报文，将该 ARP 查询报文放入一个具有广播目的地址（FF:<zero-width space>FF:<zero-width space>FF:<zero-width space>FF:<zero-width space>FF:FF）的以太网帧中，并向交换机发送该以太网帧，交换机将该帧转发给所有的连接设备，包括网关路由器。
网关路由器接收到该帧后，不断向上分解得到 ARP 报文，发现其中的 IP 地址与其接口的 IP 地址匹配，因此就发送一个 ARP 回答报文，包含了它的 MAC 地址，发回给主机。

3. DNS 解析域名
知道了网关路由器的 MAC 地址之后，就可以继续 DNS 的解析过程了。

网关路由器接收到包含 DNS 查询报文的以太网帧后，抽取出 IP 数据报，并根据转发表决定该 IP 数据报应该转发的路由器。
因为路由器具有内部网关协议（RIP、OSPF）和外部网关协议（BGP）这两种路由选择协议，因此路由表中已经配置了网关路由器到达 DNS 服务器的路由表项。
到达 DNS 服务器之后，DNS 服务器抽取出 DNS 查询报文，并在 DNS 数据库中查找待解析的域名。
找到 DNS 记录之后，发送 DNS 回答报文，将该回答报文放入 UDP 报文段中，然后放入 IP 数据报中，通过路由器反向转发回网关路由器，并经过以太网交换机到达主机。

4. HTTP 请求页面
有了 HTTP 服务器的 IP 地址之后，主机就能够生成 TCP 套接字，该套接字将用于向 Web 服务器发送 HTTP GET 报文。

在生成 TCP 套接字之前，必须先与 HTTP 服务器进行三次握手来建立连接。生成一个具有目的端口 80 的 TCP SYN 报文段，并向 HTTP 服务器发送该报文段。
HTTP 服务器收到该报文段之后，生成 TCP SYN ACK 报文段，发回给主机。
连接建立之后，浏览器生成 HTTP GET 报文，并交付给 HTTP 服务器。
HTTP 服务器从 TCP 套接字读取 HTTP GET 报文，生成一个 HTTP 响应报文，将 Web 页面内容放入报文主体中，发回给主机。
浏览器收到 HTTP 响应报文后，抽取出 Web 页面内容，之后进行渲染，显示 Web 页面。

## 传输层

### 概述

为上层提供简单灵活，无连接的数据报服务
IP协议将异构的物理网络连接起来

与 IP 协议配套使用的还有三个协议：
地址解析协议 ARP（Address Resolution Protocol）
网际控制报文协议 ICMP（Internet Control Message Protocol）
为了更好地转发IP数据包和提交交付成功的机会
ICMP 报文分为差错报告报文和询问报文。
应用： 
Ping   
Traceroute:用来跟踪一个分组从源点到终点的路径。Traceroute 发送的 IP 数据报封装的是无法交付的 UDP 用户数据报，并由目的主机发送终点不可达差错报告报文。

网际组管理协议 IGMP（Internet Group Management Protocol）

